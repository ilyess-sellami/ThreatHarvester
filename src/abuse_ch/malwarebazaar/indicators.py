import requests
from src.abuse_ch.config import MALWAREBAZAAR_BASE_URL, HEADERS
from .normalize import normalize_malwarebazaar_item


def fetch_recent():
    """
    Fetch recent MalwareBazaar IOCs (latest 100) and return them.
    """
    payload = {"query": "get_recent", "selector": "100"}
    try:
        response = requests.post(
            MALWAREBAZAAR_BASE_URL, headers=HEADERS, data=payload, timeout=30
        )
        response.raise_for_status()
        data = response.json()

        if data.get("query_status") != "ok":
            print(f"[!] Query failed: {data.get('query_status')}")
            return []

        iocs = [normalize_malwarebazaar_item(item) for item in data.get("data", [])]
        print(f"[*] Retrieved {len(iocs)} MalwareBazaar IOCs.")
        return iocs

    except requests.exceptions.HTTPError as e:
        print(f"[!] HTTP Error: {e}")
    except Exception as e:
        print(f"[!] Error: {e}")
